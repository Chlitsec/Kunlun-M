{% extends "dashboard/base.html" %}
{% block title %}Documentation{% endblock %}

{% block body %}
<div id="wmd-preview" class="wmd-preview wmd-preview-full-reader" data-medium-element="true" style="height: auto; left: 0px;"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="fdi8" id="cobra-w开发文档">Cobra-W开发文档</h1><div class="md-section-divider"></div><h2 data-anchor-id="qn68" id="开始">开始</h2><p data-anchor-id="smo8">使用-h可以查看使用帮助</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="k0e9" style=""><ol class="linenums"><li class="L0"><code><span class="pln">python </span><span class="pun">.</span><span class="pln">\cobra</span><span class="pun">.</span><span class="pln">py </span><span class="pun">-</span><span class="pln">h</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">usage</span><span class="pun">:</span><span class="pln"> cobra </span><span class="pun">[-</span><span class="pln">h</span><span class="pun">]</span><span class="pln"> </span><span class="pun">[-</span><span class="pln">t </span><span class="str">&lt;target&gt;</span><span class="pun">]</span><span class="pln"> </span><span class="pun">[-</span><span class="pln">f </span><span class="str">&lt;format&gt;</span><span class="pun">]</span><span class="pln"> </span><span class="pun">[-</span><span class="pln">o </span><span class="str">&lt;output&gt;</span><span class="pun">]</span><span class="pln"> </span><span class="pun">[-</span><span class="pln">r </span><span class="str">&lt;rule_id&gt;</span><span class="pun">]</span></code></li><li class="L3"><code><span class="pln">             </span><span class="pun">[-</span><span class="pln">s </span><span class="str">&lt;secret_name&gt;</span><span class="pun">]</span><span class="pln"> </span><span class="pun">[-</span><span class="pln">d</span><span class="pun">]</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">  ____      _                  __        __</span></code></li><li class="L6"><code><span class="pln"> </span><span class="pun">/</span><span class="pln"> ___</span><span class="pun">|</span><span class="pln">___ </span><span class="pun">|</span><span class="pln"> </span><span class="pun">|</span><span class="pln">__  _ __ __ _    \ \      </span><span class="pun">/</span><span class="pln"> </span><span class="pun">/</span></code></li><li class="L7"><code><span class="pun">|</span><span class="pln"> </span><span class="pun">|</span><span class="pln">   </span><span class="str">/ _ \| '_ \| '__/</span><span class="pln"> _</span><span class="str">` |    \ \ /\ / /</span></code></li><li class="L8"><code><span class="str">| |__| (_) | |_) | | | (_| | --- \ V  V /</span></code></li><li class="L9"><code><span class="str"> \____\___/|_.__/|_|  \__,_|      \_/\_/  v0.8.3</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="str">GitHub: https://github.com/LoRexxar/Cobra-W</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="str">Cobra is a static code analysis system that automates the detecting vulnerabilities and security issue.</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="str">optional arguments:</span></code></li><li class="L6"><code><span class="str">  -h, --help            show this help message and exit</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="str">Scan:</span></code></li><li class="L9"><code><span class="str">  -t &lt;target&gt;, --target &lt;target&gt;</span></code></li><li class="L0"><code><span class="str">                        file, folder, compress, or repository address</span></code></li><li class="L1"><code><span class="str">  -f &lt;format&gt;, --format &lt;format&gt;</span></code></li><li class="L2"><code><span class="str">                        vulnerability output format (formats: html, json, csv,</span></code></li><li class="L3"><code><span class="str">                        xml)</span></code></li><li class="L4"><code><span class="str">  -o &lt;output&gt;, --output &lt;output&gt;</span></code></li><li class="L5"><code><span class="str">                        vulnerability output STREAM, FILE</span></code></li><li class="L6"><code><span class="str">  -r &lt;rule_id&gt;, --rule &lt;rule_id&gt;</span></code></li><li class="L7"><code><span class="str">                        specifies rules e.g: 1000, 1001</span></code></li><li class="L8"><code><span class="str">  -s &lt;secret_name&gt;, --secret &lt;secret_name&gt;</span></code></li><li class="L9"><code><span class="str">                        secret repair function e.g: wordpress</span></code></li><li class="L0"><code><span class="str">  -d, --debug           open debug mode</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="str">Usage:</span></code></li><li class="L3"><code><span class="str">  python cobra.py -t tests/vulnerabilities</span></code></li><li class="L4"><code><span class="str">  python cobra.py -t tests/vulnerabilities -r 1000, 1001</span></code></li><li class="L5"><code><span class="str">  python cobra.py -t tests/vulnerabilities -s wordpress</span></code></li><li class="L6"><code><span class="str">  python cobra.py -t tests/vulnerabilities -f json -o /tmp/report.json</span></code></li><li class="L7"><code><span class="str">  python cobra.py -t tests/vulnerabilities --debug</span></code></li></ol></pre><div class="md-section-divider"></div><h2 data-anchor-id="priy" id="核心代码">核心代码</h2><p data-anchor-id="hu6j">整个核心代码的运行逻辑：</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="my66" style=""><ol class="linenums"><li class="L0"><code><span class="pln">__init__</span><span class="pun">.</span><span class="pln">py </span><span class="pun">-&gt;</span><span class="pln"> cli</span><span class="pun">.</span><span class="pln">py</span><span class="pun">主线程</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="kwd">until</span><span class="pun">.</span><span class="pln">py</span><span class="pun">加载规则库</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> detection</span><span class="pun">.</span><span class="pln">py </span><span class="pun">判断扫描对象的语言和框架</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> engine</span><span class="pun">.</span><span class="pln">py</span><span class="pun">(</span><span class="pln">scan</span><span class="pun">)</span><span class="pln"> </span><span class="pun">启动扫描</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> cast</span><span class="pun">.</span><span class="pln">py ast </span><span class="pun">-&gt;</span><span class="pln"> parser</span><span class="pun">.</span><span class="pln">py ast</span><span class="pun">分析</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> engine</span><span class="pun">.</span><span class="pln">py </span><span class="pun">整理结果</span><span class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span class="kwd">export</span><span class="pun">.</span><span class="pln">py </span><span class="pun">导出结果</span></code></li></ol></pre><ul data-anchor-id="f3iy">
<li>init.py：  参数的解析和对应配置</li>
<li>cli.py:    开始扫描前的一些预处理</li>
<li>cast.py:   ast中预处理的一些代码，如匹配函数获取变量名</li>
<li>config.py: 一些配置文件目录的配置</li>
<li>const.py:  一些常量的配置</li>
<li>engine.py: 扫描主逻辑，处理扫描已经扫描结果处理</li>
<li>export.py: 扫描结果的处理</li>
<li>file.py:   底层文件操作的处理</li>
<li>log.py:    log日志配置</li>
<li>parser.py  AST核心文件</li>
<li>rule.py    规则处理文件</li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="db4o" id="规则模块">规则模块</h2><p data-anchor-id="71bc">规则目录结构为</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="n4s5" style=""><ol class="linenums"><li class="L0"><code><span class="pln">rules</span><span class="pun">/{语言类型}/</span><span class="pln">CVI_xxxx</span><span class="pun">.</span><span class="pln">py</span></code></li></ol></pre><p data-anchor-id="sj1w">在规则目录下，只有命名符合规定的规则会被成功加载，命名格式严格为<code>CVI_编号.py</code></p><p data-anchor-id="v21r">规则默认格式为</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ktph" style=""><ol class="linenums"><li class="L0"><code><span class="com"># -*- coding: utf-8 -*-</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="str">"""</span></code></li><li class="L3"><code><span class="str">    CVI-1000</span></code></li><li class="L4"><code><span class="str">    ~~~~</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="str">    Reflected XSS</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="str">    :author:    LoRexxar &lt;LoRexxar@gmail.com&gt;</span></code></li><li class="L9"><code><span class="str">    :homepage:  https://github.com/LoRexxar/cobra</span></code></li><li class="L0"><code><span class="str">    :license:   MIT, see LICENSE for more details.</span></code></li><li class="L1"><code><span class="str">    :copyright: Copyright (c) 2017 LoRexxar. All rights reserved</span></code></li><li class="L2"><code><span class="str">"""</span></code></li><li class="L3"><code></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="kwd">class</span><span class="pln"> CVI_1000</span><span class="pun">():</span></code></li><li class="L6"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L7"><code><span class="str">    rule class</span></code></li><li class="L8"><code><span class="str">    """</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> __init__</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">):</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">svid </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1000</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">language </span><span class="pun">=</span><span class="pln"> </span><span class="str">"PHP"</span></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">author </span><span class="pun">=</span><span class="pln"> </span><span class="str">"LoRexxar/wufeifei"</span></code></li><li class="L5"><code><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">vulnerability </span><span class="pun">=</span><span class="pln"> </span><span class="str">"Reflected XSS"</span></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">description </span><span class="pun">=</span><span class="pln"> </span><span class="str">"Reflected XSS"</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">        </span><span class="com"># status</span></code></li><li class="L9"><code><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">status </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">True</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="pln">        </span><span class="com"># 部分配置</span></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">match_mode </span><span class="pun">=</span><span class="pln"> </span><span class="str">"function-param-regex"</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">match </span><span class="pun">=</span><span class="pln"> </span><span class="str">"echo|print|print_r|exit|die|printf|vprintf|trigger_error|user_error|odbc_result_all|ovrimos_result_all|ifx_htmltbl_result"</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">    </span><span class="kwd">def</span><span class="pln"> main</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">,</span><span class="pln"> regex_string</span><span class="pun">):</span></code></li><li class="L6"><code><span class="pln">        </span><span class="str">"""</span></code></li><li class="L7"><code><span class="str">        regex string input</span></code></li><li class="L8"><code><span class="str">        :regex_string: regex match string</span></code></li><li class="L9"><code><span class="str">        :return:</span></code></li><li class="L0"><code><span class="str">        """</span></code></li><li class="L1"><code><span class="pln">        </span><span class="kwd">pass</span></code></li></ol></pre><p data-anchor-id="idsp"><strong>规则类必须和文件名相同，否则规则库会加载无效</strong></p><p data-anchor-id="nzkc">init里为规则的一部分设置 <br>
- svid: 规则编号 <br>
- language： 语言类型（会和扫描对象向匹配，使用对应的规则脚本） <br>
- author: 规则作者 <br>
- vulnrability: 漏洞类型 <br>
- description: 漏洞描述 <br>
- statu: 表示是否开启该规则 <br>
- match_mode: 规则匹配方法（下面详解） <br>
- match: 敏感函数正则，漏洞语句正则</p><div class="md-section-divider"></div><h3 data-anchor-id="2acn" id="规则匹配类型">规则匹配类型</h3><p data-anchor-id="ovin">暂时把规则匹配方法分为三类：</p><ul data-anchor-id="fpcj">
<li><p>only-regex <br>
纯正则匹配，符合正则的点会直接被判定为漏洞点，不进入任何参数分析等...一个非常特殊的匹配模式。</p></li>
<li><p>function-param-regex <br>
函数正则匹配，通过匹配敏感函数来判断漏洞点，然后敏感函数中的所有变量会进入AST分析流程，如果匹配到其中参数可控，就会被判定为漏洞点。</p></li>
<li><p>vustomize-match <br>
自定义匹配，先通过正则匹配漏洞存在点，然后进入自定义的参数解析函数(规则中的main函数)，自定义解析到目标参数<strong>列表</strong>，返回进入ast分析，回溯可控变量。</p></li>
</ul><div class="md-section-divider"></div><h2 data-anchor-id="u0ix" id="语法分析部分">语法分析部分</h2><p data-anchor-id="05b4">语法分析的代码主要集中在case.py和parser.py两个文件，case主要负责处理AST的前期准备（参数确认）和AST分析后的结果处理。 </p><p data-anchor-id="iog7">核心的语法分析主要是parser.py。</p><p data-anchor-id="1chz">整个分析过程依赖python的phply模块作语法分析，代码主要是对分析结果做处理。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="6d0p" style=""><ol class="linenums"><li class="L0"><code><span class="pln">test_single_file</span><span class="pun">.</span><span class="pln">php</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pun">&lt;?</span><span class="pln">php</span></code></li><li class="L3"><code><span class="pln">include</span><span class="pun">(</span><span class="str">"test1.php"</span><span class="pun">);</span></code></li><li class="L4"><code><span class="pln">include </span><span class="str">"test2.php"</span><span class="pun">;</span></code></li><li class="L5"><code></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="com"># 不可控</span></code></li><li class="L8"><code><span class="pln">$url </span><span class="pun">=</span><span class="pln"> </span><span class="str">"phpinfo()"</span><span class="pun">;</span></code></li><li class="L9"><code><span class="kwd">eval</span><span class="pun">(</span><span class="pln">$url</span><span class="pun">);</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="com"># 可控</span></code></li><li class="L2"><code><span class="pln">$url </span><span class="pun">=</span><span class="pln"> $_GET</span><span class="pun">[</span><span class="str">'a'</span><span class="pun">];</span></code></li><li class="L3"><code><span class="kwd">eval</span><span class="pun">(</span><span class="pln">$url</span><span class="pun">);</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="com"># 可控</span></code></li><li class="L6"><code><span class="kwd">eval</span><span class="pun">(</span><span class="pln">$url2</span><span class="pun">);</span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="com"># 不可控</span></code></li><li class="L9"><code><span class="kwd">eval</span><span class="pun">(</span><span class="pln">$url3</span><span class="pun">);</span></code></li><li class="L0"><code></code></li><li class="L1"><code><span class="com"># 经过一次</span></code></li><li class="L2"><code><span class="pln">$url4 </span><span class="pun">=</span><span class="pln"> $test</span><span class="pun">;</span></code></li><li class="L3"><code><span class="kwd">eval</span><span class="pun">(</span><span class="pln">$url4</span><span class="pun">);</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="com"># 函数</span></code></li><li class="L6"><code><span class="pln"> </span><span class="kwd">function</span><span class="pln"> test</span><span class="pun">(){</span></code></li><li class="L7"><code><span class="pln">     </span><span class="kwd">return</span><span class="pln"> $_GET</span><span class="pun">[</span><span class="str">'a'</span><span class="pun">];</span></code></li><li class="L8"><code><span class="pln"> </span><span class="pun">}</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">$url5 </span><span class="pun">=</span><span class="pln"> test</span><span class="pun">();</span></code></li><li class="L1"><code><span class="kwd">eval</span><span class="pun">(</span><span class="pln">$url5</span><span class="pun">);</span></code></li><li class="L2"><code></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">$a </span><span class="pun">=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span></code></li><li class="L5"><code><span class="kwd">if</span><span class="pun">(</span><span class="pln">a </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">){</span></code></li><li class="L6"><code><span class="pln">    </span><span class="kwd">eval</span><span class="pun">(</span><span class="pln">$url4</span><span class="pun">);</span></code></li><li class="L7"><code><span class="pun">}</span></code></li></ol></pre><p data-anchor-id="14nm">上面的代码会被解析成相应的节点</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="0x72" style=""><ol class="linenums"><li class="L0"><code><span class="typ">Include</span><span class="pun">(</span><span class="str">'test1.php'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">False</span><span class="pun">)</span></code></li><li class="L1"><code><span class="typ">Include</span><span class="pun">(</span><span class="str">'test2.php'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">False</span><span class="pun">)</span></code></li><li class="L2"><code><span class="typ">Assignment</span><span class="pun">(</span><span class="typ">Variable</span><span class="pun">(</span><span class="str">'$url'</span><span class="pun">),</span><span class="pln"> </span><span class="str">'phpinfo()'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">False</span><span class="pun">)</span></code></li><li class="L3"><code><span class="typ">Eval</span><span class="pun">(</span><span class="typ">Variable</span><span class="pun">(</span><span class="str">'$url'</span><span class="pun">))</span></code></li><li class="L4"><code><span class="typ">Assignment</span><span class="pun">(</span><span class="typ">Variable</span><span class="pun">(</span><span class="str">'$url'</span><span class="pun">),</span><span class="pln"> </span><span class="typ">ArrayOffset</span><span class="pun">(</span><span class="typ">Variable</span><span class="pun">(</span><span class="str">'$_GET'</span><span class="pun">),</span><span class="pln"> </span><span class="str">'a'</span><span class="pun">),</span><span class="pln"> </span><span class="kwd">False</span><span class="pun">)</span></code></li><li class="L5"><code><span class="typ">Eval</span><span class="pun">(</span><span class="typ">Variable</span><span class="pun">(</span><span class="str">'$url'</span><span class="pun">))</span></code></li><li class="L6"><code><span class="typ">Eval</span><span class="pun">(</span><span class="typ">Variable</span><span class="pun">(</span><span class="str">'$url2'</span><span class="pun">))</span></code></li><li class="L7"><code><span class="typ">Eval</span><span class="pun">(</span><span class="typ">Variable</span><span class="pun">(</span><span class="str">'$url3'</span><span class="pun">))</span></code></li><li class="L8"><code><span class="typ">Assignment</span><span class="pun">(</span><span class="typ">Variable</span><span class="pun">(</span><span class="str">'$url4'</span><span class="pun">),</span><span class="pln"> </span><span class="typ">Variable</span><span class="pun">(</span><span class="str">'$test'</span><span class="pun">),</span><span class="pln"> </span><span class="kwd">False</span><span class="pun">)</span></code></li><li class="L9"><code><span class="typ">Eval</span><span class="pun">(</span><span class="typ">Variable</span><span class="pun">(</span><span class="str">'$url4'</span><span class="pun">))</span></code></li><li class="L0"><code><span class="typ">Function</span><span class="pun">(</span><span class="str">'test'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[],</span><span class="pln"> </span><span class="pun">[</span><span class="typ">Return</span><span class="pun">(</span><span class="typ">ArrayOffset</span><span class="pun">(</span><span class="typ">Variable</span><span class="pun">(</span><span class="str">'$_GET'</span><span class="pun">),</span><span class="pln"> </span><span class="str">'a'</span><span class="pun">))],</span><span class="pln"> </span><span class="kwd">False</span><span class="pun">)</span></code></li><li class="L1"><code><span class="typ">Assignment</span><span class="pun">(</span><span class="typ">Variable</span><span class="pun">(</span><span class="str">'$url5'</span><span class="pun">),</span><span class="pln"> </span><span class="typ">FunctionCall</span><span class="pun">(</span><span class="str">'test'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">[]),</span><span class="pln"> </span><span class="kwd">False</span><span class="pun">)</span></code></li><li class="L2"><code><span class="typ">Eval</span><span class="pun">(</span><span class="typ">Variable</span><span class="pun">(</span><span class="str">'$url5'</span><span class="pun">))</span></code></li><li class="L3"><code><span class="typ">Assignment</span><span class="pun">(</span><span class="typ">Variable</span><span class="pun">(</span><span class="str">'$a'</span><span class="pun">),</span><span class="pln"> </span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">False</span><span class="pun">)</span></code></li><li class="L4"><code><span class="typ">If</span><span class="pun">(</span><span class="typ">BinaryOp</span><span class="pun">(</span><span class="str">'=='</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Constant</span><span class="pun">(</span><span class="str">'a'</span><span class="pun">),</span><span class="pln"> </span><span class="lit">1</span><span class="pun">),</span><span class="pln"> </span><span class="typ">Block</span><span class="pun">([</span><span class="typ">Eval</span><span class="pun">(</span><span class="typ">Variable</span><span class="pun">(</span><span class="str">'$url4'</span><span class="pun">))]),</span><span class="pln"> </span><span class="pun">[],</span><span class="pln"> </span><span class="kwd">None</span><span class="pun">)</span></code></li></ol></pre><p data-anchor-id="cy44">节点列表会用倒序的方式逐步回溯目标变量，从这里开始不同的规则模式就需要不同的回溯方式了。</p><div class="md-section-divider"></div><h3 data-anchor-id="z55e" id="function-param-regex">function-param-regex</h3><p data-anchor-id="i965">function-param-regex采用的是类似于正向分析的逻辑。</p><p data-anchor-id="d37v">从<code>parser.py 1383行</code>的<code>scan_parser</code>函数进入，调用phply的parser的来分析当前代码文件的ast树，然后进入analysis函数进入不同的处理函数。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ra6i" style=""><ol class="linenums"><li class="L0"><code><span class="kwd">def</span><span class="pln"> analysis</span><span class="pun">(</span><span class="pln">nodes</span><span class="pun">,</span><span class="pln"> vul_function</span><span class="pun">,</span><span class="pln"> back_node</span><span class="pun">,</span><span class="pln"> vul_lineo</span><span class="pun">,</span><span class="pln"> file_path</span><span class="pun">=</span><span class="kwd">None</span><span class="pun">,</span><span class="pln"> function_params</span><span class="pun">=</span><span class="kwd">None</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L2"><code><span class="str">    调用FunctionCall--&gt;analysis_functioncall分析调用函数是否敏感</span></code></li><li class="L3"><code><span class="str">    :param nodes: 所有节点</span></code></li><li class="L4"><code><span class="str">    :param vul_function: 要判断的敏感函数名</span></code></li><li class="L5"><code><span class="str">    :param back_node: 各种语法结构里面的语句</span></code></li><li class="L6"><code><span class="str">    :param vul_lineo: 漏洞函数所在行号</span></code></li><li class="L7"><code><span class="str">    :param function_params: 自定义函数的所有参数列表</span></code></li><li class="L8"><code><span class="str">    :param file_path: 当前分析文件的地址</span></code></li><li class="L9"><code><span class="str">    :return:</span></code></li><li class="L0"><code><span class="str">    """</span></code></li><li class="L1"><code><span class="pln">    buffer_ </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[]</span></code></li><li class="L2"><code><span class="pln">    </span><span class="kwd">for</span><span class="pln"> node </span><span class="kwd">in</span><span class="pln"> nodes</span><span class="pun">:</span></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">if</span><span class="pln"> isinstance</span><span class="pun">(</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> php</span><span class="pun">.</span><span class="typ">FunctionCall</span><span class="pun">):</span><span class="pln">  </span><span class="com"># 函数直接调用，不进行赋值</span></code></li><li class="L4"><code><span class="pln">            anlysis_function</span><span class="pun">(</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> back_node</span><span class="pun">,</span><span class="pln"> vul_function</span><span class="pun">,</span><span class="pln"> function_params</span><span class="pun">,</span><span class="pln"> vul_lineo</span><span class="pun">,</span><span class="pln"> file_path</span><span class="pun">=</span><span class="pln">file_path</span><span class="pun">)</span></code></li><li class="L5"><code></code></li><li class="L6"><code><span class="pln">        </span><span class="kwd">elif</span><span class="pln"> isinstance</span><span class="pun">(</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> php</span><span class="pun">.</span><span class="typ">Assignment</span><span class="pun">):</span><span class="pln">  </span><span class="com"># 函数调用在赋值表达式中</span></code></li><li class="L7"><code><span class="pln">            </span><span class="kwd">if</span><span class="pln"> isinstance</span><span class="pun">(</span><span class="pln">node</span><span class="pun">.</span><span class="pln">expr</span><span class="pun">,</span><span class="pln"> php</span><span class="pun">.</span><span class="typ">FunctionCall</span><span class="pun">):</span></code></li><li class="L8"><code><span class="pln">                anlysis_function</span><span class="pun">(</span><span class="pln">node</span><span class="pun">.</span><span class="pln">expr</span><span class="pun">,</span><span class="pln"> back_node</span><span class="pun">,</span><span class="pln"> vul_function</span><span class="pun">,</span><span class="pln"> function_params</span><span class="pun">,</span><span class="pln"> vul_lineo</span><span class="pun">,</span><span class="pln"> file_path</span><span class="pun">=</span><span class="pln">file_path</span><span class="pun">)</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">            </span><span class="kwd">if</span><span class="pln"> isinstance</span><span class="pun">(</span><span class="pln">node</span><span class="pun">.</span><span class="pln">expr</span><span class="pun">,</span><span class="pln"> php</span><span class="pun">.</span><span class="typ">Eval</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">                analysis_eval</span><span class="pun">(</span><span class="pln">node</span><span class="pun">.</span><span class="pln">expr</span><span class="pun">,</span><span class="pln"> vul_function</span><span class="pun">,</span><span class="pln"> back_node</span><span class="pun">,</span><span class="pln"> vul_lineo</span><span class="pun">,</span><span class="pln"> function_params</span><span class="pun">,</span><span class="pln"> file_path</span><span class="pun">=</span><span class="pln">file_path</span><span class="pun">)</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">            </span><span class="kwd">if</span><span class="pln"> isinstance</span><span class="pun">(</span><span class="pln">node</span><span class="pun">.</span><span class="pln">expr</span><span class="pun">,</span><span class="pln"> php</span><span class="pun">.</span><span class="typ">Silence</span><span class="pun">):</span></code></li><li class="L4"><code><span class="pln">                buffer_</span><span class="pun">.</span><span class="pln">append</span><span class="pun">(</span><span class="pln">node</span><span class="pun">.</span><span class="pln">expr</span><span class="pun">)</span></code></li><li class="L5"><code><span class="pln">                analysis</span><span class="pun">(</span><span class="pln">buffer_</span><span class="pun">,</span><span class="pln"> vul_function</span><span class="pun">,</span><span class="pln"> back_node</span><span class="pun">,</span><span class="pln"> vul_lineo</span><span class="pun">,</span><span class="pln"> file_path</span><span class="pun">,</span><span class="pln"> function_params</span><span class="pun">)</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">        </span><span class="kwd">elif</span><span class="pln"> isinstance</span><span class="pun">(</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> php</span><span class="pun">.</span><span class="typ">Print</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">or</span><span class="pln"> isinstance</span><span class="pun">(</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> php</span><span class="pun">.</span><span class="typ">Echo</span><span class="pun">):</span></code></li><li class="L8"><code><span class="pln">            analysis_echo_print</span><span class="pun">(</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> back_node</span><span class="pun">,</span><span class="pln"> vul_function</span><span class="pun">,</span><span class="pln"> vul_lineo</span><span class="pun">,</span><span class="pln"> function_params</span><span class="pun">,</span><span class="pln"> file_path</span><span class="pun">=</span><span class="pln">file_path</span><span class="pun">)</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">elif</span><span class="pln"> isinstance</span><span class="pun">(</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> php</span><span class="pun">.</span><span class="typ">Silence</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">            nodes </span><span class="pun">=</span><span class="pln"> get_silence_params</span><span class="pun">(</span><span class="pln">node</span><span class="pun">)</span></code></li><li class="L2"><code><span class="pln">            analysis</span><span class="pun">(</span><span class="pln">nodes</span><span class="pun">,</span><span class="pln"> vul_function</span><span class="pun">,</span><span class="pln"> back_node</span><span class="pun">,</span><span class="pln"> vul_lineo</span><span class="pun">,</span><span class="pln"> file_path</span><span class="pun">)</span></code></li><li class="L3"><code></code></li><li class="L4"><code><span class="pln">        </span><span class="kwd">elif</span><span class="pln"> isinstance</span><span class="pun">(</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> php</span><span class="pun">.</span><span class="typ">Eval</span><span class="pun">):</span></code></li><li class="L5"><code><span class="pln">            analysis_eval</span><span class="pun">(</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> vul_function</span><span class="pun">,</span><span class="pln"> back_node</span><span class="pun">,</span><span class="pln"> vul_lineo</span><span class="pun">,</span><span class="pln"> function_params</span><span class="pun">,</span><span class="pln"> file_path</span><span class="pun">=</span><span class="pln">file_path</span><span class="pun">)</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">        </span><span class="kwd">elif</span><span class="pln"> isinstance</span><span class="pun">(</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> php</span><span class="pun">.</span><span class="typ">Include</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">or</span><span class="pln"> isinstance</span><span class="pun">(</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> php</span><span class="pun">.</span><span class="typ">Require</span><span class="pun">):</span></code></li><li class="L8"><code><span class="pln">            analysis_file_inclusion</span><span class="pun">(</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> vul_function</span><span class="pun">,</span><span class="pln"> back_node</span><span class="pun">,</span><span class="pln"> vul_lineo</span><span class="pun">,</span><span class="pln"> function_params</span><span class="pun">,</span><span class="pln"> file_path</span><span class="pun">=</span><span class="pln">file_path</span><span class="pun">)</span></code></li><li class="L9"><code></code></li><li class="L0"><code><span class="pln">        </span><span class="kwd">elif</span><span class="pln"> isinstance</span><span class="pun">(</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> php</span><span class="pun">.</span><span class="typ">If</span><span class="pun">):</span><span class="pln">  </span><span class="com"># 函数调用在if-else语句中时</span></code></li><li class="L1"><code><span class="pln">            analysis_if_else</span><span class="pun">(</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> back_node</span><span class="pun">,</span><span class="pln"> vul_function</span><span class="pun">,</span><span class="pln"> vul_lineo</span><span class="pun">,</span><span class="pln"> function_params</span><span class="pun">,</span><span class="pln"> file_path</span><span class="pun">=</span><span class="pln">file_path</span><span class="pun">)</span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">        </span><span class="kwd">elif</span><span class="pln"> isinstance</span><span class="pun">(</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> php</span><span class="pun">.</span><span class="typ">While</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">or</span><span class="pln"> isinstance</span><span class="pun">(</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> php</span><span class="pun">.</span><span class="typ">For</span><span class="pun">):</span><span class="pln">  </span><span class="com"># 函数调用在循环中</span></code></li><li class="L4"><code><span class="pln">            </span><span class="kwd">if</span><span class="pln"> isinstance</span><span class="pun">(</span><span class="pln">node</span><span class="pun">.</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> php</span><span class="pun">.</span><span class="typ">Block</span><span class="pun">):</span></code></li><li class="L5"><code><span class="pln">                analysis</span><span class="pun">(</span><span class="pln">node</span><span class="pun">.</span><span class="pln">node</span><span class="pun">.</span><span class="pln">nodes</span><span class="pun">,</span><span class="pln"> vul_function</span><span class="pun">,</span><span class="pln"> back_node</span><span class="pun">,</span><span class="pln"> vul_lineo</span><span class="pun">,</span><span class="pln"> file_path</span><span class="pun">,</span><span class="pln"> function_params</span><span class="pun">)</span></code></li><li class="L6"><code></code></li><li class="L7"><code><span class="pln">        </span><span class="kwd">elif</span><span class="pln"> isinstance</span><span class="pun">(</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> php</span><span class="pun">.</span><span class="typ">Function</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">or</span><span class="pln"> isinstance</span><span class="pun">(</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> php</span><span class="pun">.</span><span class="typ">Method</span><span class="pun">):</span></code></li><li class="L8"><code><span class="pln">            function_body </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[]</span></code></li><li class="L9"><code><span class="pln">            function_params </span><span class="pun">=</span><span class="pln"> get_function_params</span><span class="pun">(</span><span class="pln">node</span><span class="pun">.</span><span class="kwd">params</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">            analysis</span><span class="pun">(</span><span class="pln">node</span><span class="pun">.</span><span class="pln">nodes</span><span class="pun">,</span><span class="pln"> vul_function</span><span class="pun">,</span><span class="pln"> function_body</span><span class="pun">,</span><span class="pln"> vul_lineo</span><span class="pun">,</span><span class="pln"> function_params</span><span class="pun">=</span><span class="pln">function_params</span><span class="pun">,</span><span class="pln"> file_path</span><span class="pun">=</span><span class="pln">file_path</span><span class="pun">)</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">        </span><span class="kwd">elif</span><span class="pln"> isinstance</span><span class="pun">(</span><span class="pln">node</span><span class="pun">,</span><span class="pln"> php</span><span class="pun">.</span><span class="typ">Class</span><span class="pun">):</span></code></li><li class="L3"><code><span class="pln">            analysis</span><span class="pun">(</span><span class="pln">node</span><span class="pun">.</span><span class="pln">nodes</span><span class="pun">,</span><span class="pln"> vul_function</span><span class="pun">,</span><span class="pln"> back_node</span><span class="pun">,</span><span class="pln"> vul_lineo</span><span class="pun">,</span><span class="pln"> file_path</span><span class="pun">,</span><span class="pln"> function_params</span><span class="pun">)</span></code></li><li class="L4"><code></code></li><li class="L5"><code><span class="pln">        back_node</span><span class="pun">.</span><span class="pln">append</span><span class="pun">(</span><span class="pln">node</span><span class="pun">)</span></code></li></ol></pre><p data-anchor-id="6r29">当分析过程中获取到与敏感函数相同的函数调用时，把所选位置的代码以及变量传入<code>anlysis_params</code>函数中，进入语义分析。</p><div class="md-section-divider"></div><h3 data-anchor-id="e3ny" id="vustomize-match">vustomize-match</h3><p data-anchor-id="5atc">vustomize-match自定义匹配和函数匹配有一点儿不同，vustomize-match的基础在于正则表达式，正则表达式的匹配不依赖任何的语义，所以从漏洞扫描的第一步就非常的依赖正则表达式的精度。</p><p data-anchor-id="q834">如果正则表达式写的足够好，可以在第一时间就节省很多不必要的麻烦。</p><p data-anchor-id="im8g"><code>cast.py 241行</code>，当正则表达式匹配到相应的语句是，将会读取该文件的文件内容，以及匹配到相应的参数，传入<code>anlysis_params</code>中。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="puhz" style=""><ol class="linenums"><li class="L0"><code><span class="pln">_is_co</span><span class="pun">,</span><span class="pln"> _cp</span><span class="pun">,</span><span class="pln"> expr_lineno </span><span class="pun">=</span><span class="pln"> anlysis_params</span><span class="pun">(</span><span class="pln">param_name</span><span class="pun">,</span><span class="pln"> param_content</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">file_path</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">line</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">sr</span><span class="pun">.</span><span class="pln">vul_function</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">repair_functions</span><span class="pun">)</span></code></li></ol></pre><p data-anchor-id="v273">同样的，经过一定程度的处理，进入语义分析。</p><div class="md-section-divider"></div><h3 data-anchor-id="05id" id="递归语义分析">递归语义分析</h3><p data-anchor-id="duj9"><code>deep_parameters_back</code>和<code>parameters_back</code>是两个设计为递归分析语义树的函数，deep主要负责跨文件的判断，另外一个主要是负责一个代码块中的回溯分析。</p><p data-anchor-id="k5k8">调用<code>deep_parameters_back</code>进入深度递归回溯变量。</p><p data-anchor-id="1y5c">递归过程主要是<code>parameters_back</code>函数，仍然是倒序寻找变量赋值语句，然后左值保留，右值作为可控变量再次进入<code>parameters_back</code>函数。</p><p data-anchor-id="krim">语义分析的核心就在于这个函数<code>parameters_back</code>，在这里通过多种语句，分割不同的代码子块，再次递归分析代码。</p><p></p><p data-anchor-id="m1vt">在整个递归逻辑上，判断的唯一条件就是，目标参数是否为可控或者不可控，只有在得到确认的变量时，就可以从递归中退出。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="pl51" style=""><ol class="linenums"><li class="L0"><code><span class="pln">controlled_params </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L1"><code><span class="pln">  </span><span class="str">'$_GET'</span><span class="pun">,</span></code></li><li class="L2"><code><span class="pln">  </span><span class="str">'$_POST'</span><span class="pun">,</span></code></li><li class="L3"><code><span class="pln">  </span><span class="str">'$_REQUEST'</span><span class="pun">,</span></code></li><li class="L4"><code><span class="pln">  </span><span class="str">'$_COOKIE'</span><span class="pun">,</span></code></li><li class="L5"><code><span class="pln">  </span><span class="str">'$_FILES'</span><span class="pun">,</span></code></li><li class="L6"><code><span class="pln">  </span><span class="com"># '$_SERVER', # 暂时去掉了，误报率太高了</span></code></li><li class="L7"><code><span class="pln">  </span><span class="str">'$HTTP_POST_FILES'</span><span class="pun">,</span></code></li><li class="L8"><code><span class="pln">  </span><span class="str">'$HTTP_COOKIE_VARS'</span><span class="pun">,</span></code></li><li class="L9"><code><span class="pln">  </span><span class="str">'$HTTP_REQUEST_VARS'</span><span class="pun">,</span></code></li><li class="L0"><code><span class="pln">  </span><span class="str">'$HTTP_POST_VARS'</span><span class="pun">,</span></code></li><li class="L1"><code><span class="pln">  </span><span class="str">'$HTTP_RAW_POST_DATA'</span><span class="pun">,</span></code></li><li class="L2"><code><span class="pln">  </span><span class="str">'$HTTP_GET_VARS'</span><span class="pln"> </span><span class="pun">]</span></code></li></ol></pre><p data-anchor-id="bafj">经过一系列的语义分析之后，目标参数会带着相应的参数类型返回结果</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ym2l" style=""><ol class="linenums"><li class="L0"><code><span class="kwd">if</span><span class="pln"> result</span><span class="pun">[</span><span class="lit">0</span><span class="pun">][</span><span class="str">'code'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">1</span><span class="pun">:</span><span class="pln">  </span><span class="com"># 函数参数可控</span></code></li><li class="L1"><code><span class="pln">  </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">True</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Function-param-controllable'</span><span class="pln">   </span></code></li><li class="L2"><code><span class="kwd">if</span><span class="pln"> result</span><span class="pun">[</span><span class="lit">0</span><span class="pun">][</span><span class="str">'code'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">2</span><span class="pun">:</span><span class="pln">  </span><span class="com"># 漏洞修复</span></code></li><li class="L3"><code><span class="pln">  </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">False</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Function-param-controllable but fixed'</span><span class="pln">   </span></code></li><li class="L4"><code><span class="kwd">if</span><span class="pln"> result</span><span class="pun">[</span><span class="lit">0</span><span class="pun">][</span><span class="str">'code'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="pun">-</span><span class="lit">1</span><span class="pun">:</span><span class="pln">  </span><span class="com"># 函数参数不可控</span></code></li><li class="L5"><code><span class="pln">  </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">False</span><span class="pun">,</span><span class="pln"> </span><span class="str">'Function-param-uncon'</span><span class="pln">   </span></code></li><li class="L6"><code><span class="kwd">if</span><span class="pln"> result</span><span class="pun">[</span><span class="lit">0</span><span class="pun">][</span><span class="str">'code'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">4</span><span class="pun">:</span><span class="pln">  </span><span class="com"># 新规则生成</span></code></li><li class="L7"><code><span class="pln">  </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">False</span><span class="pun">,</span><span class="pln"> </span><span class="str">'New Core'</span><span class="pun">,</span><span class="pln"> result</span><span class="pun">[</span><span class="lit">0</span><span class="pun">][</span><span class="str">'source'</span><span class="pun">]</span></code></li></ol></pre><p data-anchor-id="zzz7">除了上面的几个以外，还有一个<code>code == 3</code>，为该参数不确定是否可控，一般当code为3是返回了结果，代表语义分析完成时，仍然没得到确认的结果，无法判断是否为漏洞。</p><p data-anchor-id="c3jb">当<code>code == 4</code>的时候，就会进入一个特殊的逻辑中，auto rule机制</p><div class="md-section-divider"></div><h3 data-anchor-id="g1a8" id="auto-rule机制">auto rule机制</h3><p data-anchor-id="q07j">Auto rule机制是一个Cobra-W中新加的特有机制，当敏感函数的调用在函数中，而敏感函数回溯变量的结果为，从函数参数中获取，那么我就会把这个函数作为新的rule进行下一次扫描，类的扫描同理，区别是要从析构函数中读取函数参数。</p><p data-anchor-id="3z9t">为了能够实现，新的auto rule不影响原有的漏洞扫描，仅在中间部分添加一次扫描，并可以实现递归生成新的auto rule，我把auto rule的入口点添加在了<code>SingleRule 的process</code>中调用Core的地方，将所有auto rule的返回结果和Core原本的返回结果拼接起来合并返回。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="3ap3" style=""><ol class="linenums"><li class="L0"><code><span class="pln">new_rule_vulnerabilities </span><span class="pun">=</span><span class="pln"> </span><span class="typ">NewCore</span><span class="pun">(</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">sr</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">target_directory</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">files</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> secret_name</span><span class="pun">=</span><span class="kwd">self</span><span class="pun">.</span><span class="pln">secret_name</span><span class="pun">)</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="kwd">if</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">new_rule_vulnerabilities</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">:</span></code></li><li class="L3"><code><span class="pln">    </span><span class="kwd">self</span><span class="pun">.</span><span class="pln">rule_vulnerabilities</span><span class="pun">.</span><span class="pln">extend</span><span class="pun">(</span><span class="pln">new_rule_vulnerabilities</span><span class="pun">)</span></code></li></ol></pre><p data-anchor-id="9sxp">auto rule的第一步是生成新的正则规则，当我们获取到危险函数时，我们进一步匹配函数调用点，然后还需要去除函数定义的部分。</p><p data-anchor-id="bogd">engine.py 678行</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="t5br" style=""><ol class="linenums"><li class="L0"><code><span class="pln">match </span><span class="pun">=</span><span class="pln"> </span><span class="str">"(?:\A|\s)"</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> function_name </span><span class="pun">+</span><span class="pln"> </span><span class="str">"\s*\("</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">match2 </span><span class="pun">=</span><span class="pln"> </span><span class="str">"function\s+"</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> function_name</span></code></li></ol></pre><p data-anchor-id="oh90">类相关的比较简单</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="qkfu" style=""><ol class="linenums"><li class="L0"><code><span class="pln">match </span><span class="pun">=</span><span class="pln"> </span><span class="str">"new\s*"</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> class_name </span><span class="pun">+</span><span class="pln"> </span><span class="str">"\s*\("</span></code></li><li class="L1"><code></code></li><li class="L2"><code><span class="pln">match2 </span><span class="pun">=</span><span class="pln"> </span><span class="str">"class\s+"</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> class_name </span><span class="pun">+</span><span class="pln"> </span><span class="str">"\s*{"</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="z1mk" id="secret机制">secret机制</h3><p data-anchor-id="mn94">除了正向的深化递归分析以外，我们还常常遇到一种情况。</p><p data-anchor-id="sc8f">很多CMS在处理代码的安全问题时，面临的特殊情况比较多，所以单纯的自带过滤函数没办法满足多种情况的需求，所以CMS一般都有自建的安全过滤函数，其中很多过滤函数甚至都不会使用到常用的过滤函数。</p><p data-anchor-id="17ar">在人来完成的代码分析时，我们可以很容易的把这些无法被绕过的安全过滤函数作为这个漏洞不成立的条件，但是自动分析的代码却做不到，于是我引入了secret机制，通过人来设定一些特有的过滤函数，这样一来大幅度减少了误报率。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="1irq" style=""><ol class="linenums"><li class="L0"><code><span class="pln">rules</span><span class="pun">/</span><span class="pln">secret</span><span class="pun">/</span><span class="pln">wordpress</span><span class="pun">.</span><span class="pln">py</span></code></li><li class="L1"><code><span class="pln">wordpress</span></code></li><li class="L2"><code><span class="pln">   </span><span class="pun">~~~~</span></code></li><li class="L3"><code><span class="pln">   secret </span><span class="kwd">for</span><span class="pln"> wordpress </span></code></li><li class="L4"><code><span class="pln">   </span><span class="pun">:</span><span class="pln">author</span><span class="pun">:</span><span class="pln">    </span><span class="typ">LoRexxar</span><span class="pln"> </span><span class="pun">&lt;</span><span class="typ">LoRexxar@gmail</span><span class="pun">.</span><span class="pln">com</span><span class="pun">&gt;</span><span class="pln"> </span></code></li><li class="L5"><code><span class="pln">   </span><span class="pun">:</span><span class="pln">homepage</span><span class="pun">:</span><span class="pln">  https</span><span class="pun">:</span><span class="com">//github.com/LoRexxar/cobra </span></code></li><li class="L6"><code><span class="pln">   </span><span class="pun">:</span><span class="pln">license</span><span class="pun">:</span><span class="pln">   MIT</span><span class="pun">,</span><span class="pln"> see LICENSE </span><span class="kwd">for</span><span class="pln"> more details</span><span class="pun">.</span><span class="pln"> </span></code></li><li class="L7"><code><span class="pln">   </span><span class="pun">:</span><span class="pln">copyright</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Copyright</span><span class="pln"> </span><span class="pun">(</span><span class="pln">c</span><span class="pun">)</span><span class="pln"> </span><span class="lit">2017</span><span class="pln"> </span><span class="typ">LoRexxar</span><span class="pun">.</span><span class="pln"> </span><span class="typ">All</span><span class="pln"> rights reserved </span></code></li><li class="L8"><code><span class="str">"""   </span></code></li><li class="L9"><code><span class="str">wordpress = {</span></code></li><li class="L0"><code><span class="str">  "</span><span class="pln">esc_url</span><span class="str">": [1000, 10001],</span></code></li><li class="L1"><code><span class="str">  "</span><span class="pln">esc_js</span><span class="str">": [1000, 10001],</span></code></li><li class="L2"><code><span class="str">  "</span><span class="pln">esc_html</span><span class="str">": [1000, 10001],</span></code></li><li class="L3"><code><span class="str">  "</span><span class="pln">esc_attr</span><span class="str">": [1000, 10001],</span></code></li><li class="L4"><code><span class="str">  "</span><span class="pln">esc_textarea</span><span class="str">": [1000, 10001],</span></code></li><li class="L5"><code><span class="str">  "</span><span class="pln">tag_escape</span><span class="str">": [1000, 10001],</span></code></li><li class="L6"><code><span class="str">  "</span><span class="pln">esc_sql</span><span class="str">": [1004, 1005, 1006],</span></code></li><li class="L7"><code><span class="str">  "</span><span class="pln">_real_escape</span><span class="str">": [1004, 1005, 1006], </span></code></li><li class="L8"><code><span class="str">}</span></code></li></ol></pre><p data-anchor-id="hrzf"><strong>secret字典必须和文件名相同，否则会加载无效</strong></p><p data-anchor-id="um2r">相应的函数名，会在<code>parser.py 257行</code>进行判断，过滤相应的结果</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="dl75" style=""><ol class="linenums"><li class="L0"><code><span class="kwd">def</span><span class="pln"> is_repair</span><span class="pun">(</span><span class="pln">expr</span><span class="pun">):</span></code></li><li class="L1"><code><span class="pln">    </span><span class="str">"""</span></code></li><li class="L2"><code><span class="str">     判断赋值表达式是否出现过滤函数，如果已经过滤，停止污点回溯，判定漏洞已修复  </span></code></li><li class="L3"><code><span class="str">    :param expr: 赋值表达式  </span></code></li><li class="L4"><code><span class="str">    :return:</span></code></li><li class="L5"><code><span class="str">     """</span><span class="pln">  </span></code></li><li class="L6"><code><span class="pln">    is_re </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">False</span><span class="pln"> </span><span class="com"># 是否修复，默认值是未修复</span></code></li><li class="L7"><code><span class="pln">    </span><span class="kwd">global</span><span class="pln"> is_repair_functions</span></code></li><li class="L8"><code><span class="pln">      </span><span class="kwd">if</span><span class="pln"> expr </span><span class="kwd">in</span><span class="pln"> is_repair_functions</span><span class="pun">:</span></code></li><li class="L9"><code><span class="pln">          logger</span><span class="pun">.</span><span class="pln">debug</span><span class="pun">(</span><span class="str">"[AST] function {} in is_repair_functions, The vulnerability does not exist "</span><span class="pun">)</span></code></li><li class="L0"><code><span class="pln">          is_re </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">True</span></code></li><li class="L1"><code><span class="pln">    </span><span class="kwd">return</span><span class="pln"> is_re</span></code></li></ol></pre></div>
{% endblock %}

{% block script %}


<script src="http://cdn.bootcss.com/pagedown/1.0/Markdown.Converter.js"></script>

<script>
      $(document).ready(function () {
          $("#dashboard").removeClass("active menu-open");
          $("#dashboard").find("ul li").removeClass("active");
          $("#docs").addClass("active");

      });
</script>


{% endblock %}